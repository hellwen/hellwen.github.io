<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh-cn" lang="zh-cn">
<head>
  <link href="//gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.55.2" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Deploy kubernetes by manual on centos 7 &middot; Hellwen</title>

  
  <link type="text/css" rel="stylesheet" href="https://hellwen.github.io/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://hellwen.github.io/css/poole.css">
  <link type="text/css" rel="stylesheet" href="https://hellwen.github.io/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://hellwen.github.io/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.png">

  
  <link href="" rel="alternate" type="application/rss+xml" title="Hellwen" />

  
</head>

  <body class="theme-base-09 ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://hellwen.github.io/"><h1>Hellwen</h1></a>
      <p class="lead">
       This a private blog 
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="https://hellwen.github.io/">Home</a> </li>
        <li><a href="/tags/"> Tags </a></li>
      </ul>
    </nav>

    <p>&copy; 2019. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>Deploy kubernetes by manual on centos 7</h1>
  <time datetime=2017-01-18T00:00:00Z class="post-date">Wed, Jan 18, 2017</time>
  

<h1 id="环境信息">环境信息</h1>

<p>|ip|role|hostname|
|&ndash;|&mdash;-|&mdash;&mdash;&ndash;|
|10.10.0.1|master&amp;minion|k8s-master-1|
|10.10.0.2|minion|k8s-node-1|
|10.10.0.3|minion|k8s-node-2|</p>

<h1 id="on-all-machine">on all machine</h1>

<p><em>Note: 部署的时候最好关闭selinux，否则像 nfs会挂载失败(nfs用于使用pv，不是必须的)</em></p>

<h2 id="修改hostname">修改hostname</h2>

<p>用户名建议使用中横杠，因为后面在进行kubernetes配置的时候可以直接使用hostname作为节点名称</p>

<pre><code class="language-shell">echo &quot;k8s-node-xx&quot; &gt; /etc/hostname
</code></pre>

<h2 id="基本配置">基本配置</h2>

<p>关闭防火墙
安装ntp</p>

<pre><code class="language-shell">sudo systemctl stop firewalld
sudo systemctl disable firewalld

sudo yum -y install ntp
sudo systemctl start ntpd
sudo systemctl enable ntpd
sudo systemctl status ntpd
</code></pre>

<p>创建k8s帐号和sudo</p>

<pre><code>sudo useradd -u 1008 k8s -m &amp;&amp; sudo passwd k8s

sudo echo &quot;&quot; &gt;&gt; /etc/sudoers
sudo echo &quot;#add k8s user&quot; &gt;&gt; /etc/sudoers
sudo echo &quot;k8s ALL=(ALL) NOPASSWD: ALL&quot; &gt;&gt; /etc/sudoers
</code></pre>

<p>从下面开始所以操作都是在k8s这个用户下进行</p>

<h1 id="on-master">on master</h1>

<h2 id="etcd">etcd</h2>

<h3 id="download-install-etcd">Download &amp;&amp; Install etcd</h3>

<p>etcd是类似与zookeeper的分布式配置存储解决方案，特意加了“配置”两个字是因为它的设计目标主要是用来存储配置文件</p>

<p>下载地址：<a href="https://github.com/coreos/etcd/releases/download/v3.0.9/etcd-v3.0.9-linux-amd64.tar.gz">etcd v3.0.9</a></p>

<pre><code class="language-shell">wget https://github.com/coreos/etcd/releases/download/v3.0.9/etcd-v3.0.9-linux-amd64.tar.gz
tar -zxf etcd-v3.0.9-linux-amd64.tar.gz
ln -s etcd-v3.0.9-linux-amd64 etcd
</code></pre>

<h3 id="启动配置脚本">启动配置脚本</h3>

<p>因为这是实验环境，所以这里的etcd只使用一个节点，如果你是用于生产环境建议配置3个以上的etcd节点</p>

<pre><code>cd ~/etcd
cat &lt;&lt;EOF &gt; etcd-start.sh
#! /bin/sh

THIS_IP=10.10.0.1

./etcd \
--name=infra1 \
--advertise-client-urls http://${THIS_IP}:2379 \
--listen-client-urls http://${THIS_IP}:2379,http://127.0.0.1:2379 \
--data-dir=data  \
1&gt; etcd.log 2&gt;&amp;1
EOF
chmod a+x etcd-start.sh
</code></pre>

<h3 id="使用配置脚本启动etcd">使用配置脚本启动etcd</h3>

<pre><code>./etcd-start.sh
</code></pre>

<h3 id="测试etcd">测试etcd</h3>

<pre><code>./etcdctl ls
</code></pre>

<p>如果上述命令成功，那么etcd处于正常运行中</p>

<h3 id="添加flannel的网络地址范围到etcd中">添加flannel的网络地址范围到etcd中</h3>

<pre><code>cd ~/etcd
./etcdctl mk /flannel/network/config '{&quot;Network&quot;:&quot;172.1.0.0/16&quot;}'
</code></pre>

<p>其中 /flannel/network/config这个地址是可以自己指定的，需要配置到flannel中</p>

<h2 id="kubernetes">Kubernetes</h2>

<h3 id="下载并配置kubernetes">下载并配置kubernetes</h3>

<p>kubernetes因为发布节奏很快，所以各种仓库都不会及时更新，所以本文采用手动安装方式，安装包可以直接在github上下载</p>

<p>下载地址：<a href="https://github.com/kubernetes/kubernetes/releases/download/v1.4.6/kubernetes.tar.gz">kubernetes v1.4.6</a></p>

<p>这里需要注意，kubernetes v1.5以后不再提供bin文件，所以你如果下载1.5以后的版本需要另外下载bin文件</p>

<pre><code class="language-shell">wget https://github.com/kubernetes/kubernetes/releases/download/v1.4.6/kubernetes.tar.gz
tar zxf kubernetes.tar.gz
cd kubernetes/server
tar zxf kubernetes-server-linux-amd64.tar.gz
cd kubernetes/server/bin
mkdir -p ~/kubernetes-master/log
cp kube-apiserver kube-controller-manager kubectl kube-dns kube-scheduler ~/kubernetes-master/

# 将bin添加到path中
echo &quot;export PATH=~/kubernetes-master:\$PATH&quot; &gt;&gt; ~/.bash_profile

source ~/.bash_profile
</code></pre>

<h3 id="init配置文件">init配置文件</h3>

<pre><code>cd ~/kubernetes-master
cat &lt;&lt;EOF &gt; init.sh
#! /bin/sh

KUBE_MASTER=10.10.0.1

# Change to root auth
sudo chown root.root kube-dns
sudo chmod u+s kube-dns
EOF
chmod a+x init.sh
./init.sh
</code></pre>

<p>kube-dns需要使用root权限</p>

<h3 id="api启动配置文件">api启动配置文件</h3>

<pre><code>cd ~/kubernetes-master
cat &lt;&lt;EOF &gt; start_k8s_api.sh
#! /bin/sh

# start the main server of k8s master
sudo ./kube-apiserver \
    --bind-address=0.0.0.0 \
    --insecure-bind-address=0.0.0.0 \
    --insecure-port=8080 \
    --etcd_servers=http://10.10.0.1:2379 \
    --allow-privileged=true \
    --service-cluster-ip-range=182.1.0.0/16 \
    --log-dir=&quot;log&quot; \
1&gt; k8s-api.log 2&gt;&amp;1
EOF
chmod a+x start_k8s_api.sh
</code></pre>

<h3 id="controller-manager配置文件">controller-manager配置文件</h3>

<pre><code>cd ~/kubernetes-master
cat &lt;&lt;EOF &gt; start_k8s_cm.sh
#! /bin/sh

./kube-controller-manager \
    --master=&quot;http://127.0.0.1:8080&quot; \
    --log-dir=&quot;log&quot; \
1&gt; k8s-cm.log 2&gt;&amp;1
EOF
chmod a+x start_k8s_cm.sh
</code></pre>

<h3 id="dns配置文件">dns配置文件</h3>

<pre><code>cd ~/kubernetes-master
cat &lt;&lt;EOF &gt; start_k8s_dns.sh
#! /bin/sh

KUBE_DOMAIN=&quot;cluster.local&quot;

sudo ./kube-dns \
    --domain=${KUBE_DOMAIN} \
    --kube-master-url=&quot;http://127.0.0.1:8080&quot; \
    --dns-port=53 \
    --log-dir=&quot;log&quot; \
1&gt; k8s-dns.log 2&gt;&amp;1
EOF
chmod a+x start_k8s_dns.sh
</code></pre>

<h3 id="scheduler配置文件">scheduler配置文件</h3>

<pre><code>cd ~/kubernetes-master
cat &lt;&lt;EOF &gt; start_k8s_scd.sh
#! /bin/sh

./kube-scheduler \
    --master=&quot;http://127.0.0.1:8080&quot; \
    --log-dir=&quot;log&quot; \
1&gt; k8s-scd.log 2&gt;&amp;1
EOF
chmod a+x start_k8s_scd.sh
</code></pre>

<h3 id="start-master">start master</h3>

<pre><code class="language-shell">cd ~/etcd
./start_etcd.sh

cd ~/kubernetes-master
./start_k8s_api.sh
./start_k8s_dns.sh
./start_k8s_cm.sh
./start_k8s_scd.sh
</code></pre>

<h1 id="on-minions">on minions</h1>

<p>minion需要部署所有机器上
master上也需要部署minion</p>

<h2 id="flannel">flannel</h2>

<h3 id="download-install-flannel">Download &amp;&amp; Install flannel</h3>

<p><a href="https://github.com/coreos/flannel/releases/download/v0.6.1/flannel-v0.6.1-linux-amd64.tar.gz">flannel v0.6.1</a></p>

<pre><code class="language-shell">cd ~
wget https://github.com/coreos/flannel/releases/download/v0.6.1/flannel-v0.6.1-linux-amd64.tar.gz
tar -zxf flannel-v0.6.1-linux-amd64.tar.gz
mkdir flannel
mv flannel-v0.6.1-linux-amd64.tar.gz flannel
cd ~/flannel/
tar -zxf flannel-v0.6.1-linux-amd64.tar.gz
</code></pre>

<h3 id="启动配置脚本-1">启动配置脚本</h3>

<pre><code>cd ~/flannel
cat &lt;&lt;EOF &gt; flanneld-start.sh
#! /bin/sh

ETCD_PREFIX=/flannel/network

# delete docker0. it will recreate in docker starting
rc=0
ip link show docker0 &gt;/dev/null 2&gt;&amp;1 || rc=&quot;$?&quot;
if [[ &quot;$rc&quot; -eq &quot;0&quot; ]]; then
  sudo ip link set dev docker0 down
  sudo ip link delete docker0
fi

sudo ./flanneld \
    --ip-masq \
    --subnet-file=&quot;run/subnet.env&quot; \
    --etcd-endpoints=http://10.10.0.1:2379 \
    --etcd-prefix=$ETCD_PREFIX &gt; flanneld.log 2&gt;&amp;1
EOF
chmod a+x flanneld-start.sh
</code></pre>

<h2 id="kubernetes-1">kubernetes</h2>

<pre><code class="language-shell">wget https://github.com/kubernetes/kubernetes/releases/download/v1.4.6/kubernetes.tar.gz
tar zxf kubernetes.tar.gz
cd kubernetes/server
tar zxf kubernetes-server-linux-amd64.tar.gz
cd kubernetes/server/bin
mkdir -p ~/kubernetes/log
mkdir -p ~/kubernetes/cert
mv kubelet kube-proxy ~/kubernetes/
</code></pre>

<h3 id="kubeconfig配置文件">kubeconfig配置文件</h3>

<pre><code>cat &lt;&lt; EOF &gt; /home/k8s/kubernetes/kubeconfig
apiVersion: v1
clusters:
- cluster:
    insecure-skip-tls-verify: true
    server: https://10.10.0.1:8080
  name: k8s-cluster
contexts:
- context:
    cluster: k8s-cluster
    namespace: default
  name: dft
- context:
    cluster: k8s-cluster
    namespace: kube-system
  name: sys
current-context: dft
kind: Config
preferences: {}
EOF
</code></pre>

<h3 id="kubelet配置文件">kubelet配置文件</h3>

<p>NODE_IP分别指定两台minion机器，分别是10.10.0.2和10.10.0.3</p>

<pre><code>cd ~/kubernetes
cat &lt;&lt;EOF &gt; k8s-let-start.sh
#! /bin/sh

KUBE_MASTER=10.10.0.1
NODE_IP=10.10.0.1
CLUSTER_DOMAIN=cluster.local

sudo ./kubelet \
    --address=0.0.0.0 \
    --port=10250 \
    --hostname_override=$NODE_IP \
    --require-kubeconfig=true \
    --kubeconfig=&quot;/home/k8s/kubernetes/kubeconfig&quot; \
    --cni-bin-dir=cni/bin \
    --cni-conf-dir=cni/net.d \
    --logtostderr=false \
    --allow-privileged=true \
    --pod-infra-container-image=registry.access.redhat.com/rhel7/pod-infrastructure:latest \
    --cluster-dns=$KUBE_MASTER \
    --cluster-domain=$CLUSTER_DOMAIN \
    --pod-manifest-path=&quot;manifests&quot; \
    --log-dir=&quot;log&quot; \
1&gt; k8s-let.log 2&gt;&amp;1
EOF
chmod a+x k8s-let-start.sh
</code></pre>

<h3 id="kube-proxy配置文件">kube-proxy配置文件</h3>

<pre><code>cd ~/kubernetes
cat &lt;&lt;EOF &gt; k8s-proxy-start.sh
#! /bin/sh

NODE_IP=10.10.0.1

sudo ./kube-proxy \
    --kubeconfig=&quot;/home/k8s/kubernetes/kubeconfig&quot; \
    --hostname_override=$NODE_IP \
    --proxy-mode=iptables \
    --log-dir=&quot;log&quot; \
1&gt; k8s-proxy.log 2&gt;&amp;1
EOF
chmod a+x k8s-proxy-start.sh
</code></pre>

<h2 id="init-start-minion">Init &amp; Start minion</h2>

<h3 id="配置flannel和docker0">配置flannel和docker0</h3>

<p>启动flannel</p>

<pre><code class="language-shell">cd ~/flannel
./start_flanneld.sh
</code></pre>

<p>如果是第一次启动需要进行docker的ip配置</p>

<pre><code>sudo ./mk-docker-opts.sh -f ./run/subnet.env -d ./run/docker.env
cat ./run/docker.env | grep -i DOCKER_OPTS
</code></pre>

<p>记录下上面命令输出的内容，内容大概如下：</p>

<pre><code>--bip=172.17.95.1/24 --mtu=1472
</code></pre>

<p>编辑docker-network，并修改DOCKER_NETWORK_OPTIONS参数，填入上面输出的内容</p>

<p>类似与下面的结果：</p>

<pre><code>sudo vi /etc/sysconfig/docker-network
DOCKER_NETWORK_OPTIONS=&quot; --bip=172.17.95.1/24 --mtu=1472&quot;
</code></pre>

<p>上述步骤是用于配置docker0中可分配的网段，如果使用yum install flannel在启动时会自动配置</p>

<p>重新启动docker</p>

<pre><code>sudo systemctl restart docker
</code></pre>

<p>通过ip a确定docker0和flannel0是在同一个网段</p>

<pre><code class="language-shell">ip a
</code></pre>

<h3 id="start-kubelet">start kubelet</h3>

<pre><code class="language-shell">cd ~/kubernetes
./start_k8s_let.sh
./start_k8s_proxy.sh
</code></pre>

<p>相同的步骤配置10.10.0.2和10.10.0.3
配置完成后三个节点都会加入到集群中</p>

<h1 id="验证">验证</h1>

<p>登录到10.10.0.1上</p>

<pre><code>kubectl get no
</code></pre>

<p>检查上个节点是否已配置完成</p>

<p>Done</p>

</div>

<h2>Comments</h2>
<div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "devcows" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </main>

    
  </body>
</html>
